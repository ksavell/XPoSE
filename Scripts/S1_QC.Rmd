---
title: "S1_QC"
author: "Kareem"
date: "2023-03-14"
output: html_document
---
#Load Packages
```{r}
library(Seurat)
library(ggplot2)
library(dplyr)
library(clustree)
library(tidyverse)
if (!require("BiocManager", quietly = TRUE))
    install.packages("BiocManager")

BiocManager::install("ComplexHeatmap")
```
#Load Object
```{r}
setwd("/Users/woodskad/Desktop/Analysis/S1/")
load("/Users/woodskad/Desktop/Analysis/S1/Robject/glut_subset_forthpipe_11102022.RData")
load("/Users/woodskad/Desktop/Analysis/S1/Robject/gaba_subset_forthpipe_03142023.RData")
```

#GLUT SUBSET
#Glut Vlnplot (Genes Expressed)
```{r}
pdf(file = "/Users/woodskad/Library/CloudStorage/Box-Box/mRFP-snSeq/Project1_XPoSEseq/XPoSEseq_manuscript/S1_panels/Glut/GlutVln_Gene_Exp_AAcols.pdf",
    width = 2,
    height = 2)
VlnPlot(glut.subset2, 
        features = c("nFeature_RNA"), 
        pt.size = 0, 
        ncol = 1,
        flip = T,
        cols = c("#64C7C8", "#41B75F", "#2C8CB9", "#0A5B8C", "#3C9E64", "#6F499D" )) + 
  coord_flip() + 
  theme(legend.position = "none") + 
  theme(axis.title = element_blank()) +
  ggtitle(NULL)
dev.off()
```

#Glut Vlnplot (Transcripts Expressed)
```{r}
pdf(file = "/Users/woodskad/Library/CloudStorage/Box-Box/mRFP-snSeq/Project1_XPoSEseq/XPoSEseq_manuscript/S1_panels/Glut/GlutVln_transcripts_AAcols.pdf",
    width = 2,
    height = 2)
VlnPlot(glut.subset2, 
        features = c("nCount_RNA"), 
        pt.size = 0, 
        ncol = 1,
        flip = T,
        cols = c("#64C7C8", "#41B75F", "#2C8CB9", "#0A5B8C", "#3C9E64", "#6F499D" )) + 
  coord_flip() +
  theme(legend.position = "none") + 
  theme(axis.title = element_blank()) +
  ggtitle(NULL)
dev.off()
```
#Subset Glut object
```{r}
Cart1g <- subset(x = glut.subset2, subset = orig.ident == "C1")
Cart2g <- subset(x = glut.subset2, subset = orig.ident == "C2")
male.glut <- subset(x = glut.subset2, subset = sex == "male")
female.glut <- subset(x = glut.subset2, subset = sex == "female")

```

#UMAP Glut Cartridge 1
```{r}
pdf(file = "/Users/woodskad/Library/CloudStorage/Box-Box/mRFP-snSeq/Project1_XPoSEseq/XPoSEseq_manuscript/S1_panels/GlutUMAP_Cart1.pdf",
    width = 10,
    height = 10)
DimPlot(Cart1g, 
        cols = c("#64C7C8", "#41B75F", "#2C8CB9", "#0A5B8C", "#3C9E64", "#6F499D" ), 
        shuffle = T) + 
  theme_void() + 
  theme(legend.position = "none") + 
  ggtitle(NULL)
dev.off()
```

#UMAP Glut Cartridge 2
```{r}
pdf(file = "/Users/woodskad/Library/CloudStorage/Box-Box/mRFP-snSeq/Project1_XPoSEseq/XPoSEseq_manuscript/S1_panels/GlutUMAP_Cart2.pdf",
    width = 10,
    height = 10)
DimPlot(Cart1g, 
        cols = c("#64C7C8", "#41B75F", "#2C8CB9", "#0A5B8C", "#3C9E64", "#6F499D" ), 
        shuffle = T) + 
  theme_void() + 
  theme(legend.position = "none") + 
  ggtitle(NULL)
dev.off()
```

#UMAP Glut Group by Group
```{r}
pdf(file = "/Users/woodskad/Library/CloudStorage/Box-Box/mRFP-snSeq/Project1_XPoSEseq/XPoSEseq_manuscript/S1_panels/GlutUMAP_GroupV2.pdf",
    width = 10,
    height = 10)
DimPlot(glut.subset2, 
        group.by = "group", 
        shuffle = T) + 
  theme_void() + 
  theme(legend.position = "none") + 
  ggtitle(NULL)
dev.off()
```

#UMAP Glut male
```{r}
pdf(file = "/Users/woodskad/Library/CloudStorage/Box-Box/mRFP-snSeq/Project1_XPoSEseq/XPoSEseq_manuscript/S1_panels/GlutUMAP_male.pdf",
    width = 10,
    height = 10)
DimPlot(male.glut,
        cols =  c("#64C7C8", "#41B75F", "#2C8CB9", "#0A5B8C", "#3C9E64", "#6F499D"), 
        shuffle = T) + 
  theme_void() + 
  theme(legend.position = "none") + 
  ggtitle(NULL)
dev.off()
```

#UMAP Glut female
```{r}
pdf(file = "/Users/woodskad/Library/CloudStorage/Box-Box/mRFP-snSeq/Project1_XPoSEseq/XPoSEseq_manuscript/S1_panels/GlutUMAP_female.pdf",
    width = 10,
    height = 10)
DimPlot(female.glut,
        cols =  c("#64C7C8", "#41B75F", "#2C8CB9", "#0A5B8C", "#3C9E64", "#6F499D"), 
        shuffle = T) + 
  theme_void() + 
  theme(legend.position = "none") + 
  ggtitle(NULL)
dev.off()
```

#UMAP Glut Group by RatID
```{r}
pdf(file = "/Users/woodskad/Library/CloudStorage/Box-Box/mRFP-snSeq/Project1_XPoSEseq/XPoSEseq_manuscript/S1_panels/GlutUMAP_RatIDV2.pdf",
    width = 10,
    height = 10)
DimPlot(glut.subset2, 
        group.by = "ratID", 
        shuffle = T) + 
  theme_void() + 
  theme(legend.position = "none") + 
  ggtitle(NULL)
dev.off()
```



#GABA SUBSET
#Gaba Vlnplot (Genes Expressed)
```{r}
pdf(file = "/Users/woodskad/Library/CloudStorage/Box-Box/mRFP-snSeq/Project1_XPoSEseq/XPoSEseq_manuscript/S2_panels/Gaba/GabaVln_Gene_Exp_AAcols.pdf",
    width = 2,
    height = 2)
VlnPlot(gaba.subset2, 
        features = c("nFeature_RNA"), 
        pt.size = 0, 
        ncol = 1, 
        flip = T,
        cols = c("#E66027", "#F8991D", "#C03C82", "#A669AB", "#C52126", "#DB808C", "#B0B235"),
        y.max = 5000)  + 
  coord_flip() + 
  theme(legend.position = "none") + 
  theme(axis.title = element_blank()) +
  ggtitle(NULL)
dev.off()
```

#Gaba Vlnplot (Transcripts Expressed)
```{r}
pdf(file = "/Users/woodskad/Library/CloudStorage/Box-Box/mRFP-snSeq/Project1_XPoSEseq/XPoSEseq_manuscript/S2_panels/Gaba/GabaVln_transcripts_AAcols.pdf",
    width = 2,
    height = 2)
VlnPlot(gaba.subset2, 
        features = c("nCount_RNA"), 
        pt.size = 0, 
        ncol = 1, 
        flip = T,     
        cols = c("#E66027", "#F8991D", "#C03C82", "#A669AB", "#C52126", "#DB808C", "#B0B235"),
        y.max = 15000)+ 
  coord_flip() + 
  theme(legend.position = "none") + 
  theme(axis.title = element_blank()) +
  ggtitle(NULL)
dev.off()
```

#Subset Gaba object
```{r}
Cart1 <- subset(x = gaba.subset2, subset = orig.ident == "C1")
Cart2 <- subset(x = gaba.subset2, subset = orig.ident == "C2")
male.gaba <- subset(x = gaba.subset2, subset = sex == "male")
female.gaba <- subset(x = gaba.subset2, subset = sex == "female")

```


#UMAP Gaba Group by Cartridge1
```{r}
pdf(file = "/Users/woodskad/Library/CloudStorage/Box-Box/mRFP-snSeq/Project1_XPoSEseq/XPoSEseq_manuscript/S1_panels/Gaba/GabaUMAP_Cart1.pdf",
    width = 10,
    height = 10)
DimPlot(Cart1,
        cols = c("#E66027", "#F8991D", "#C03C82", "#A669AB", "#C52126", "#DB808C", "#B0B235")) + 
  theme_void() + 
  theme(legend.position = "none") + 
  ggtitle(NULL)
dev.off()
```
#UMAP Gaba Group by Cartridge2

```{r}
pdf(file = "/Users/woodskad/Library/CloudStorage/Box-Box/mRFP-snSeq/Project1_XPoSEseq/XPoSEseq_manuscript/S1_panels/Gaba/GabaUMAP_Cart2.pdf",
    width = 10,
    height = 10)
DimPlot(Cart2,
        cols = c("#E66027", "#F8991D", "#C03C82", "#A669AB", "#C52126", "#DB808C", "#B0B235"),
        shuffle = T) + 
  theme_void() + 
  theme(legend.position = "none") + 
  ggtitle(NULL)
dev.off()
```


#UMAP Gaba Group by Group
```{r}
pdf(file = "/Users/woodskad/Library/CloudStorage/Box-Box/mRFP-snSeq/Project1_XPoSEseq/XPoSEseq_manuscript/S1_panels/Gaba/GlutUMAP_GroupV2.pdf",
    width = 10,
    height = 10)
DimPlot(gaba.subset2, 
        group.by = "group", 
        shuffle = T) + 
  theme_void() + 
  theme(legend.position = "none") + 
  ggtitle(NULL)
dev.off()
```

#UMAP Gaba Group by male
```{r}
pdf(file = "/Users/woodskad/Library/CloudStorage/Box-Box/mRFP-snSeq/Project1_XPoSEseq/XPoSEseq_manuscript/S1_panels/Gaba/GlutUMAP_male.pdf",
    width = 10,
    height = 10)
DimPlot(male.gaba, 
        cols =  c("#E66027", "#F8991D", "#C03C82", "#A669AB", "#C52126", "#DB808C", "#B0B235"), 
        shuffle = T) + 
  theme_void() + 
  theme(legend.position = "none") + 
  ggtitle(NULL)
dev.off()
```

#UMAP Gaba Group by female
```{r}
pdf(file = "/Users/woodskad/Library/CloudStorage/Box-Box/mRFP-snSeq/Project1_XPoSEseq/XPoSEseq_manuscript/S1_panels/Gaba/GlutUMAP_female.pdf",
    width = 10,
    height = 10)
DimPlot(female.gaba, 
        cols =  c("#E66027", "#F8991D", "#C03C82", "#A669AB", "#C52126", "#DB808C", "#B0B235"), 
        shuffle = T) + 
  theme_void() + 
  theme(legend.position = "none") + 
  ggtitle(NULL)
dev.off()
```

#UMAP Gaba Group by RatID
```{r}
pdf(file = "/Users/woodskad/Library/CloudStorage/Box-Box/mRFP-snSeq/Project1_XPoSEseq/XPoSEseq_manuscript/S1_panels/Gaba/GabaUMAP_RatIDV2.pdf",
    width = 10,
    height = 10)
DimPlot(gaba.subset2, 
        group.by = "ratID", 
        shuffle = T) + 
  theme_void() + 
  theme(legend.position = "none") + 
  ggtitle(NULL)
dev.off()
```

#Glut Heatmap 
#Find Glut Markers
```{r}
glut.markers <- FindAllMarkers(glut.subset2, only.pos = TRUE, min.pct = 0.25, logfc.threshold = 0.25)
glut.markers %>% 
  group_by(cluster) %>% 
  top_n(n = 10, wt = avg_log2FC) -> top10.glut

```
#Create Heatmap
```{r}
pdf(file = "/Users/woodskad/Library/CloudStorage/Box-Box/mRFP-snSeq/Project1_XPoSEseq/XPoSEseq_manuscript/S3_panels/Heatmaps/glut_top10genes_heatmapOB.pdf",
    width = 3.5,
    height = 4.5)
glut.heatmap <- DoHeatmap(object = glut.subset2, 
                          features = (top10.glut$gene),
                          group.colors =  c("#64C7C8", "#41B75F", "#2C8CB9", "#0A5B8C", "#3C9E64", "#6F499D"),
                          label = (FALSE),
                          raster = TRUE)+

theme(axis.title = element_blank(), axis.text.y = element_text(face = "italic", size = 5), legend.position = "none")+
  
scale_fill_gradientn(colours = c("blue", "black" ,"orange"))
                  
glut.heatmap

dev.off()


```


#Gaba Heatmap 
#Find Gaba Markers
```{r}
gaba.markers <- FindAllMarkers(gaba.subset2, only.pos = TRUE, min.pct = 0.25, logfc.threshold = 0.25) 
gaba.markers %>% 
  group_by(cluster) %>% 
top_n(n = 10, wt = avg_log2FC) -> top10.gaba

```
#Create Heatmap
```{r}
pdf(file = "/Users/woodskad/Library/CloudStorage/Box-Box/mRFP-snSeq/Project1_XPoSEseq/XPoSEseq_manuscript/S3_panels/Heatmaps/gaba_top10genes_heatmapV6.pdf",
    width = 3.5,
    height = 4.5)
gaba.heatmap <- DoHeatmap(gaba.subset2, 
                          features = top10.gaba$gene,
                          group.colors = c("#E66027", "#F8991D", "#C03C82", "#A669AB", "#C52126", "#DB808C", "#B0B235"),
                          label = (FALSE),
                          raster = TRUE)+
  
theme(axis.title = element_blank(), axis.text.y = element_text(face = "italic", size = 5), legend.position = "none")

gaba.heatmap
           
                          
                         

dev.off()
```

#Glut: create Fraction/Percent Totals for Cluster_Sex_ratID for 
```{r}
glut.subset2$Cluster_ratID_Sex <- paste(glut.subset2$seurat_clusters,
                                        glut.subset2$ratID,
                                        glut.subset2$sex,
                                        glut.subset2$group,
                                        sep = "_")
glut.subset2$ratID_Sex <- paste(glut.subset2$ratID,
                                glut.subset2$sex,
                                sep = "_")
df.glut.CRS <- data.frame(table(glut.subset2$Cluster_ratID_Sex))
df.glut.RS <- data.frame(table(glut.subset2$ratID_Sex))

df.glut.CRS <- separate(df.glut.CRS, col = Var1, into = c("Cluster", "ratID", "Sex", "Group"), sep = "_")
df.glut.RS <- separate(df.glut.RS, col = Var1, into = c("ratID", "Sex"), sep = "_")

df.glut.CRS <- merge.data.frame(df.glut.CRS, 
                                df.glut.RS, 
                                by.x = c("ratID", "Sex"), 
                                by.y = c("ratID", "Sex"), 
                                all = TRUE)
df.glut.CRS$Fraction <- (df.glut.CRS$Freq.x/df.glut.CRS$Freq.y)
df.glut.CRS$Percent <- (df.glut.CRS$Fract * 100)
```
#GABA: create Fraction/Percent Totals for Cluster_Sex_ratID 
```{r}
gaba.subset2$Cluster_ratID_Sex <- paste(gaba.subset2$seurat_clusters,
                                        gaba.subset2$ratID,
                                        gaba.subset2$sex, 
                                        gaba.subset2$group,
                                        sep = "_")
gaba.subset2$ratID_Sex <- paste(gaba.subset2$ratID,
                                gaba.subset2$sex,
                                sep = "_")
df.gaba.CRS <- data.frame(table(gaba.subset2$Cluster_ratID_Sex))
df.gaba.RS <- data.frame(table(gaba.subset2$ratID_Sex))

df.gaba.CRS <- separate(df.gaba.CRS, col = Var1, into = c("Cluster", "ratID", "Sex", "Group"), sep = "_")
df.gaba.RS <- separate(df.gaba.RS, col = Var1, into = c("ratID", "Sex"), sep = "_")

df.gaba.CRS <- merge.data.frame(df.gaba.CRS, 
                                df.gaba.RS, 
                                by.x = c("ratID", "Sex"), 
                                by.y = c("ratID", "Sex"), 
                                all = TRUE)
df.gaba.CRS$Fraction <- (df.gaba.CRS$Freq.x/df.gaba.CRS$Freq.y)
df.gaba.CRS$Percent <- (df.gaba.CRS$Fract * 100)
```



#Glut: create Fraction/Percent Totals for Cluster_Sex for Bar
```{r}
glut.subset2$Cluster_Sex <- paste(glut.subset2$seurat_clusters,
                                        glut.subset2$sex,
                                        sep = "_")

df.glut.CS <- data.frame(table(glut.subset2$Cluster_Sex))
df.glut.S <- data.frame(table(glut.subset2$sex))

df.glut.CS <- separate(df.glut.CS, col = Var1, into = c("Cluster", "Sex"), sep = "_")


df.glut.CS <- merge.data.frame(df.glut.CS, 
                                df.glut.S, 
                                by.x = c("Sex"), 
                                by.y = c("Var1"), 
                                all = TRUE)
df.glut.CS$Fraction <- (df.glut.CS$Freq.x/df.glut.CS$Freq.y)
df.glut.CS$Percent <- (df.glut.CS$Fraction * 100)
```
#GABA: create Fraction/Percent Totals for Cluster_Sex for Bar
```{r}
gaba.subset2$Cluster_Sex <- paste(gaba.subset2$seurat_clusters,
                                        gaba.subset2$sex,
                                        sep = "_")

df.gaba.CS <- data.frame(table(gaba.subset2$Cluster_Sex))
df.gaba.S <- data.frame(table(gaba.subset2$sex))

df.gaba.CS <- separate(df.gaba.CS, col = Var1, into = c("Cluster", "Sex"), sep = "_")


df.gaba.CS <- merge.data.frame(df.gaba.CS, 
                                df.gaba.S, 
                                by.x = c("Sex"), 
                                by.y = c("Var1"), 
                                all = TRUE)
df.gaba.CS$Fraction <- (df.gaba.CS$Freq.x/df.gaba.CS$Freq.y)
df.gaba.CS$Percent <- (df.gaba.CS$Fraction * 100)
```

#Glut:Fraction/Percent totals for Cart1/Cart2 
```{r}
glut.subset2$cluster_cart <- paste(glut.subset2$seurat_clusters,
                                   glut.subset2$orig.ident,
                                   sep = "_")
glut.subset2$cluster <- paste(glut.subset2$seurat_clusters)

df.glut.carts <- data.frame(table(glut.subset2$cluster_cart))
df.glut.clusters <- data.frame(table(glut.subset2$cluster))

df.glut.carts <- separate(df.glut.carts, col = Var1, into = c("cluster", "cart"), sep = "_")

df.glut.carts <- merge.data.frame(df.glut.carts, 
                                  df.glut.clusters,
                                  by.x = "cluster",
                                  by.y = "Var1", 
                                  all = TRUE)
df.glut.carts$Fraction <- (df.glut.carts$Freq.x/df.glut.carts$Freq.y)
df.glut.carts$Percent <- (df.glut.carts$Fraction * 100)

```

#GABA:Fraction/Percent totals for Cart1/Cart2 
```{r}
gaba.subset2$cluster_cart <- paste(gaba.subset2$seurat_clusters,
                                   gaba.subset2$orig.ident,
                                   sep = "_")
gaba.subset2$cluster <- paste(gaba.subset2$seurat_clusters)

df.gaba.carts <- data.frame(table(gaba.subset2$cluster_cart))
df.gaba.clusters <- data.frame(table(gaba.subset2$cluster))

df.gaba.carts <- separate(df.gaba.carts, col = Var1, into = c("cluster", "cart"), sep = "_")

df.gaba.carts <- merge.data.frame(df.gaba.carts, 
                                  df.gaba.clusters,
                                  by.x = "cluster",
                                  by.y = "Var1", 
                                  all = TRUE)
df.gaba.carts$Fraction <- (df.gaba.carts$Freq.x/df.gaba.carts$Freq.y)
df.gaba.carts$Percent <- (df.gaba.carts$Fraction * 100)
```

#GLUT:Fraction/Percent clusters in Cart 1/Cart 2
```{r}
glut.subset2$cart_cluster <- paste(glut.subset2$orig.ident,
                                   glut.subset2$seurat_clusters,
                                   sep = "_")
glut.subset2$cart <- paste(glut.subset2$orig.ident)

df.glut.carts <- data.frame(table(glut.subset2$cart_cluster))
df.glut.cart.total <- data.frame(table(glut.subset2$orig.ident))

df.glut.carts <- separate(df.glut.carts, col = Var1, into = c("cart", "cluster"), sep = "_")

df.glut.carts <- merge.data.frame(df.glut.carts, 
                                  df.glut.cart.total,
                                  by.x = "cart",
                                  by.y = "Var1", 
                                  all = TRUE)
df.glut.carts$Fraction <- (df.glut.carts$Freq.x/df.glut.carts$Freq.y)
df.glut.carts$Percent <- (df.glut.carts$Fraction * 100)

```

#GABA:Fraction/Percent clusters in Cart 1/Cart 2
```{r}
gaba.subset2$cart_cluster <- paste(gaba.subset2$orig.ident,
                                   gaba.subset2$seurat_clusters,
                                   sep = "_")
gaba.subset2$cart <- paste(gaba.subset2$orig.ident)

df.gaba.carts <- data.frame(table(gaba.subset2$cart_cluster))
df.gaba.cart.total <- data.frame(table(gaba.subset2$orig.ident))

df.gaba.carts <- separate(df.gaba.carts, col = Var1, into = c("cart", "cluster"), sep = "_")

df.gaba.carts <- merge.data.frame(df.gaba.carts, 
                                  df.gaba.cart.total,
                                  by.x = "cart",
                                  by.y = "Var1", 
                                  all = TRUE)
df.gaba.carts$Fraction <- (df.gaba.carts$Freq.x/df.gaba.carts$Freq.y)
df.gaba.carts$Percent <- (df.gaba.carts$Fraction * 100)

```

#Save tables as CSV files
```{r}
write_csv(df.gaba.carts, file = "/Users/woodskad/Library/CloudStorage/Box-Box/mRFP-snSeq/Project1_XPoSEseq/XPoSEseq_manuscript/S1_panels/Tables for S1 Panels/df.gaba.carts.csv")

write_csv(df.glut.carts, file = "/Users/woodskad/Library/CloudStorage/Box-Box/mRFP-snSeq/Project1_XPoSEseq/XPoSEseq_manuscript/S1_panels/Tables for S1 Panels/df.glut.carts.csv")

write_csv(df.gaba.CS, file = "/Users/woodskad/Library/CloudStorage/Box-Box/mRFP-snSeq/Project1_XPoSEseq/XPoSEseq_manuscript/S1_panels/Tables for S1 Panels/df.gaba.CS.csv")
write_csv(df.glut.CS, file = "/Users/woodskad/Library/CloudStorage/Box-Box/mRFP-snSeq/Project1_XPoSEseq/XPoSEseq_manuscript/S1_panels/Tables for S1 Panels/df.glut.CS.csv")

write_csv(df.glut.cluster.rat, file = "/Users/woodskad/Library/CloudStorage/Box-Box/mRFP-snSeq/Project1_XPoSEseq/XPoSEseq_manuscript/S1_panels/Tables for S1 Panels/df.glut.cluster.rat.csv")
write_csv(df.glut.carts, file = "/Users/woodskad/Library/CloudStorage/Box-Box/mRFP-snSeq/Project1_XPoSEseq/XPoSEseq_manuscript/S1_panels/Tables for S1 Panels/df.glut.carts.csv")
```

