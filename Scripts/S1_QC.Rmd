---
title: "S1_QC"
author: "Kareem"
date: "2023-03-14"
output: html_document
---
#Load Packages
```{r}
library(Seurat)
library(ggplot2)
library(dplyr)
library(clustree)
library(tidyverse)
```
#Load Object
```{r}
setwd("/Users/woodskad/Desktop/Analysis/S1/")
load("/Users/woodskad/Desktop/Analysis/S1/Robject/glut_subset_forthpipe_11102022.RData")
load("/Users/woodskad/Desktop/Analysis/S1/Robject/gaba_subset_forthpipe_03142023.RData")
```

#GLUT SUBSET
#Glut Vlnplot (Genes Expressed)
```{r}
pdf(file = "/Users/woodskad/Library/CloudStorage/Box-Box/mRFP-snSeq/Project1_XPoSEseq/XPoSEseq_manuscript/S1_panels/Glut/GlutVln_Gene_ExpV4.pdf",
    width = 2,
    height = 2)
VlnPlot(glut.subset2, 
        features = c("nFeature_RNA"), 
        pt.size = 0, 
        ncol = 1,
        flip = T) + 
  coord_flip() + 
  theme(legend.position = "none") + 
  theme(axis.title = element_blank()) +
  ggtitle(NULL)
dev.off()
```

#Glut Vlnplot (Transcripts Expressed)
```{r}
pdf(file = "/Users/woodskad/Library/CloudStorage/Box-Box/mRFP-snSeq/Project1_XPoSEseq/XPoSEseq_manuscript/S1_panels/Glut/GlutVln_transcriptsV4.pdf",
    width = 2,
    height = 2)
VlnPlot(glut.subset2, 
        features = c("nCount_RNA"), 
        pt.size = 0, 
        ncol = 1,
        flip = T) + 
  coord_flip() +
  theme(legend.position = "none") + 
  theme(axis.title = element_blank()) +
  ggtitle(NULL)
dev.off()
```


#UMAP Glut Group by Cartridge
```{r}
pdf(file = "/Users/woodskad/Library/CloudStorage/Box-Box/mRFP-snSeq/Project1_XPoSEseq/XPoSEseq_manuscript/S1_panels/GlutUMAP_CartV3.pdf",
    width = 10,
    height = 10)
DimPlot(glut.subset2, 
        group.by = "orig.ident", 
        shuffle = T) + 
  theme_void() + 
  theme(legend.position = "none") + 
  ggtitle(NULL)
dev.off()
```

#UMAP Glut Group by Group
```{r}
pdf(file = "/Users/woodskad/Library/CloudStorage/Box-Box/mRFP-snSeq/Project1_XPoSEseq/XPoSEseq_manuscript/S1_panels/GlutUMAP_GroupV2.pdf",
    width = 10,
    height = 10)
DimPlot(glut.subset2, 
        group.by = "group", 
        shuffle = T) + 
  theme_void() + 
  theme(legend.position = "none") + 
  ggtitle(NULL)
dev.off()
```

#UMAP Glut Group by Sex
```{r}
pdf(file = "/Users/woodskad/Library/CloudStorage/Box-Box/mRFP-snSeq/Project1_XPoSEseq/XPoSEseq_manuscript/S1_panels/GlutUMAP_SexV2.pdf",
    width = 10,
    height = 10)
DimPlot(glut.subset2,
        group.by = "sex", 
        cols = c("skyblue2", "violetred3"), 
        shuffle = T) + 
  theme_void() + 
  theme(legend.position = "none") + 
  ggtitle(NULL)
dev.off()
```

#UMAP Glut Group by RatID
```{r}
pdf(file = "/Users/woodskad/Library/CloudStorage/Box-Box/mRFP-snSeq/Project1_XPoSEseq/XPoSEseq_manuscript/S1_panels/GlutUMAP_RatIDV2.pdf",
    width = 10,
    height = 10)
DimPlot(glut.subset2, 
        group.by = "ratID", 
        shuffle = T) + 
  theme_void() + 
  theme(legend.position = "none") + 
  ggtitle(NULL)
dev.off()
```



#GABA SUBSET
#Gaba Vlnplot (Genes Expressed)
```{r}
pdf(file = "/Users/woodskad/Library/CloudStorage/Box-Box/mRFP-snSeq/Project1_XPoSEseq/XPoSEseq_manuscript/S1_panels/Gaba/GabaVln_Gene_ExpV3.pdf",
    width = 2,
    height = 2)
VlnPlot(gaba.subset2, 
        features = c("nFeature_RNA"), 
        pt.size = 0, 
        ncol = 1, 
        flip = T) + 
  coord_flip() + 
  theme(legend.position = "none") + 
  theme(axis.title = element_blank()) +
  ggtitle(NULL)
dev.off()
```

#Gaba Vlnplot (Transcripts Expressed)
```{r}
pdf(file = "/Users/woodskad/Library/CloudStorage/Box-Box/mRFP-snSeq/Project1_XPoSEseq/XPoSEseq_manuscript/S1_panels/Gaba/GabaVln_transcriptsV3.pdf",
    width = 2,
    height = 2)
VlnPlot(gaba.subset2, 
        features = c("nCount_RNA"), 
        pt.size = 0, 
        ncol = 1, 
        flip = T) + 
  coord_flip() + 
  theme(legend.position = "none") + 
  theme(axis.title = element_blank()) +
  ggtitle(NULL)
dev.off()
```

#UMAP Gaba Group by Cartridge
```{r}
pdf(file = "/Users/woodskad/Library/CloudStorage/Box-Box/mRFP-snSeq/Project1_XPoSEseq/XPoSEseq_manuscript/S1_panels/Gaba/GabaUMAP_CartV3.pdf",
    width = 10,
    height = 10)
DimPlot(gaba.subset2, 
        group.by = "orig.ident", 
        shuffle = T) + 
  theme_void() + 
  theme(legend.position = "none") + 
  ggtitle(NULL)
dev.off()
```

#UMAP Gaba Group by Group
```{r}
pdf(file = "/Users/woodskad/Library/CloudStorage/Box-Box/mRFP-snSeq/Project1_XPoSEseq/XPoSEseq_manuscript/S1_panels/Gaba/GlutUMAP_GroupV2.pdf",
    width = 10,
    height = 10)
DimPlot(gaba.subset2, 
        group.by = "group", 
        shuffle = T) + 
  theme_void() + 
  theme(legend.position = "none") + 
  ggtitle(NULL)
dev.off()
```

#UMAP Gaba Group by Sex
```{r}
pdf(file = "/Users/woodskad/Library/CloudStorage/Box-Box/mRFP-snSeq/Project1_XPoSEseq/XPoSEseq_manuscript/S1_panels/Gaba/GlutUMAP_SexV2.pdf",
    width = 10,
    height = 10)
DimPlot(gaba.subset2, 
        group.by = "sex", 
        cols = c("skyblue2", "violetred3"), 
        shuffle = T) + 
  theme_void() + 
  theme(legend.position = "none") + 
  ggtitle(NULL)
dev.off()
```

#UMAP Gaba Group by RatID
```{r}
pdf(file = "/Users/woodskad/Library/CloudStorage/Box-Box/mRFP-snSeq/Project1_XPoSEseq/XPoSEseq_manuscript/S1_panels/Gaba/GabaUMAP_RatIDV2.pdf",
    width = 10,
    height = 10)
DimPlot(gaba.subset2, 
        group.by = "ratID", 
        shuffle = T) + 
  theme_void() + 
  theme(legend.position = "none") + 
  ggtitle(NULL)
dev.off()
```

#Glut Heatmap 
#Find Glut Markers
```{r}
glut.markers <- FindAllMarkers(glut.subset2, only.pos = TRUE, min.pct = 0.25, logfc.threshold = 0.25)
glut.markers %>% 
  group_by(cluster) %>% 
  top_n(n = 10, wt = avg_log2FC) -> top10.glut
```
#Create Heatmap
```{r}
pdf(file = "/Users/woodskad/Library/CloudStorage/Box-Box/mRFP-snSeq/Project1_XPoSEseq/XPoSEseq_manuscript/S1_panels/Heatmaps/glut_top10genes_heatmapV2.pdf",
    width = 7,
    height = 7)
glut.heatmap <- DoHeatmap(glut.subset2, features = top10.glut$gene, raster = FALSE) 
glut.heatmap

dev.off()
```


#Gaba Heatmap 
#Find Gaba Markers
```{r}
gaba.markers <- FindAllMarkers(gaba.subset2, only.pos = TRUE, min.pct = 0.25, logfc.threshold = 0.25) 
gaba.markers %>% 
  group_by(cluster) %>% 
top_n(n = 10, wt = avg_log2FC) -> top10.gaba
```
#Create Heatmap
```{r}
pdf(file = "/Users/woodskad/Library/CloudStorage/Box-Box/mRFP-snSeq/Project1_XPoSEseq/XPoSEseq_manuscript/S1_panels/Heatmaps/gaba_top10genes_heatmapV2.pdf",
    width = 7,
    height = 7)
gaba.heatmap <- DoHeatmap(gaba.subset2, features = top10.gaba$gene, raster = FALSE) 
gaba.heatmap

dev.off()
```

#Glut: create Fraction/Percent Totals for Cluster_Sex_ratID for 
```{r}
glut.subset2$Cluster_ratID_Sex <- paste(glut.subset2$seurat_clusters,
                                        glut.subset2$ratID,
                                        glut.subset2$sex,
                                        glut.subset2$group,
                                        sep = "_")
glut.subset2$ratID_Sex <- paste(glut.subset2$ratID,
                                glut.subset2$sex,
                                sep = "_")
df.glut.CRS <- data.frame(table(glut.subset2$Cluster_ratID_Sex))
df.glut.RS <- data.frame(table(glut.subset2$ratID_Sex))

df.glut.CRS <- separate(df.glut.CRS, col = Var1, into = c("Cluster", "ratID", "Sex", "Group"), sep = "_")
df.glut.RS <- separate(df.glut.RS, col = Var1, into = c("ratID", "Sex"), sep = "_")

df.glut.CRS <- merge.data.frame(df.glut.CRS, 
                                df.glut.RS, 
                                by.x = c("ratID", "Sex"), 
                                by.y = c("ratID", "Sex"), 
                                all = TRUE)
df.glut.CRS$Fraction <- (df.glut.CRS$Freq.x/df.glut.CRS$Freq.y)
df.glut.CRS$Percent <- (df.glut.CRS$Fract * 100)
```
#GABA: create Fraction/Percent Totals for Cluster_Sex_ratID 
```{r}
gaba.subset2$Cluster_ratID_Sex <- paste(gaba.subset2$seurat_clusters,
                                        gaba.subset2$ratID,
                                        gaba.subset2$sex, 
                                        gaba.subset2$group,
                                        sep = "_")
gaba.subset2$ratID_Sex <- paste(gaba.subset2$ratID,
                                gaba.subset2$sex,
                                sep = "_")
df.gaba.CRS <- data.frame(table(gaba.subset2$Cluster_ratID_Sex))
df.gaba.RS <- data.frame(table(gaba.subset2$ratID_Sex))

df.gaba.CRS <- separate(df.gaba.CRS, col = Var1, into = c("Cluster", "ratID", "Sex", "Group"), sep = "_")
df.gaba.RS <- separate(df.gaba.RS, col = Var1, into = c("ratID", "Sex"), sep = "_")

df.gaba.CRS <- merge.data.frame(df.gaba.CRS, 
                                df.gaba.RS, 
                                by.x = c("ratID", "Sex"), 
                                by.y = c("ratID", "Sex"), 
                                all = TRUE)
df.gaba.CRS$Fraction <- (df.gaba.CRS$Freq.x/df.gaba.CRS$Freq.y)
df.gaba.CRS$Percent <- (df.gaba.CRS$Fract * 100)
```

#Glut:Fraction/Percent totals for Cart1/Cart2 
```{r}
glut.subset2$cluster_cart <- paste(glut.subset2$seurat_clusters,
                                   glut.subset2$orig.ident,
                                   sep = "_")
glut.subset2$cluster <- paste(glut.subset2$seurat_clusters)

df.glut.carts <- data.frame(table(glut.subset2$cluster_cart))
df.glut.clusters <- data.frame(table(glut.subset2$cluster))

df.glut.carts <- separate(df.glut.carts, col = Var1, into = c("cluster", "cart"), sep = "_")

df.glut.carts <- merge.data.frame(df.glut.carts, 
                                  df.glut.clusters,
                                  by.x = "cluster",
                                  by.y = "Var1", 
                                  all = TRUE)
df.glut.carts$Fraction <- (df.glut.carts$Freq.x/df.glut.carts$Freq.y)
df.glut.carts$Percent <- (df.glut.carts$Fraction * 100)

```

#GABA:Fraction/Percent totals for Cart1/Cart2 
```{r}
gaba.subset2$cluster_cart <- paste(gaba.subset2$seurat_clusters,
                                   gaba.subset2$orig.ident,
                                   sep = "_")
gaba.subset2$cluster <- paste(gaba.subset2$seurat_clusters)

df.gaba.carts <- data.frame(table(gaba.subset2$cluster_cart))
df.gaba.clusters <- data.frame(table(gaba.subset2$cluster))

df.gaba.carts <- separate(df.gaba.carts, col = Var1, into = c("cluster", "cart"), sep = "_")

df.gaba.carts <- merge.data.frame(df.gaba.carts, 
                                  df.gaba.clusters,
                                  by.x = "cluster",
                                  by.y = "Var1", 
                                  all = TRUE)
df.gaba.carts$Fraction <- (df.gaba.carts$Freq.x/df.gaba.carts$Freq.y)
df.gaba.carts$Percent <- (df.gaba.carts$Fraction * 100)
```

#Glut: Fraction/Percent totals for Rat in each cluster
```{r}
glut.subset2$cluster_ratID <- paste(glut.subset2$seurat_clusters,
                                   glut.subset2$ratID,
                                   sep = "_")
glut.subset2$cluster <- paste(glut.subset2$seurat_clusters)

df.glut.cluster.rat <- data.frame(table(glut.subset2$cluster_ratID))
df.glut.clusters <- data.frame(table(glut.subset2$cluster))

df.glut.cluster.rat <- separate(df.glut.cluster.rat, col = Var1, into = c("cluster", "rat"), sep = "_")

df.glut.cluster.rat <- merge.data.frame(df.glut.cluster.rat, 
                                  df.glut.clusters,
                                  by.x = "cluster",
                                  by.y = "Var1", 
                                  all = TRUE)
df.glut.cluster.rat$Fraction <- (df.glut.cluster.rat$Freq.x/df.glut.cluster.rat$Freq.y)
df.glut.cluster.rat$Percent <- (df.glut.cluster.rat$Fraction * 100)
```

#GABA: Fraction/Percent totals for Rat in each cluster
```{r}
gaba.subset2$cluster_ratID <- paste(gaba.subset2$seurat_clusters,
                                   gaba.subset2$ratID,
                                   sep = "_")
gaba.subset2$cluster <- paste(gaba.subset2$seurat_clusters)

df.gaba.cluster.rat <- data.frame(table(gaba.subset2$cluster_ratID))
df.gaba.clusters <- data.frame(table(gaba.subset2$cluster))

df.gaba.cluster.rat <- separate(df.gaba.cluster.rat, col = Var1, into = c("cluster", "rat"), sep = "_")

df.gaba.cluster.rat <- merge.data.frame(df.gaba.cluster.rat, 
                                  df.gaba.clusters,
                                  by.x = "cluster",
                                  by.y = "Var1", 
                                  all = TRUE)
df.gaba.cluster.rat$Fraction <- (df.gaba.cluster.rat$Freq.x/df.gaba.cluster.rat$Freq.y)
df.gaba.cluster.rat$Percent <- (df.gaba.cluster.rat$Fraction * 100)
```



#Save tables as CSV files
```{r}
write_csv(df.gaba.CRS, file = "/Users/woodskad/Library/CloudStorage/Box-Box/mRFP-snSeq/Project1_XPoSEseq/XPoSEseq_manuscript/S1_panels/Tables for S1 Panels/df.gaba.CRS w Group.csv")
write_csv(df.glut.CRS, file = "/Users/woodskad/Library/CloudStorage/Box-Box/mRFP-snSeq/Project1_XPoSEseq/XPoSEseq_manuscript/S1_panels/Tables for S1 Panels/df.glut.CRS w Group.csv")

write_csv(df.gaba.cluster.rat, file = "/Users/woodskad/Library/CloudStorage/Box-Box/mRFP-snSeq/Project1_XPoSEseq/XPoSEseq_manuscript/S1_panels/Tables for S1 Panels/df.gaba.cluster.rat.csv")
write_csv(df.gaba.carts, file = "/Users/woodskad/Library/CloudStorage/Box-Box/mRFP-snSeq/Project1_XPoSEseq/XPoSEseq_manuscript/S1_panels/Tables for S1 Panels/df.gaba.carts.csv")

write_csv(df.glut.cluster.rat, file = "/Users/woodskad/Library/CloudStorage/Box-Box/mRFP-snSeq/Project1_XPoSEseq/XPoSEseq_manuscript/S1_panels/Tables for S1 Panels/df.glut.cluster.rat.csv")
write_csv(df.glut.carts, file = "/Users/woodskad/Library/CloudStorage/Box-Box/mRFP-snSeq/Project1_XPoSEseq/XPoSEseq_manuscript/S1_panels/Tables for S1 Panels/df.glut.carts.csv")
```

